#!/bin/bash
set -e

# Run migrations if DATABASE_URL is set
if [ -n "$DATABASE_URL" ]; then
  echo "Running database migrations..."
  bin/rails db:migrate
fi

# Trap signals to log why the process exits
trap 'echo "Received SIGTERM, shutting down..."' TERM
trap 'echo "Received SIGINT, shutting down..."' INT
trap 'echo "Received SIGHUP"' HUP

# Run the server in the foreground, log exit code
echo "Starting server: $@"
"$@" &
PID=$!
wait $PID
EXIT_CODE=$?
echo "Server process (PID $PID) exited with code $EXIT_CODE"
exit $EXIT_CODE
